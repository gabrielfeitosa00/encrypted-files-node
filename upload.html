<!DOCTYPE html>
<html>
  <head>
    <title>Upload : Share your files, not your secrets</title>
    <!-- Include script SJCL, jquery, recaptcha API and bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  </head>
  <body>
    <form id="form" class="w3-margin w3-padding-large">
      <h2>Select the file you wanna upload :</h2>

      <input class="w3-input" id="file" type="file" multiple required />
      <input class="w3-input" id="password" type="text" required />
      <button type="submit" class="w3-button w3-teal" id="uploadBtn">
        Upload
      </button>
      <div id="link"></div>
    </form>
    <!-- JavaScript code to get data, cipher and request the server -->
    <script>
      /**
       * @param string @file
       * The uploaded file (in string format) to encrypt
       * @param string @name
       * The name of the file in order to save it with the file for decryption process
       *
       * @return
       * A string array with 2 elements : the encrypted file and the associated key in base 64
       */
      function encryptFile(file, password, name) {
        // Generate hash
        const hash = CryptoJS.SHA256(password)
        //Create a JSON object to bind the file and its name
        const fileJSON = JSON.stringify({ data: file, hash, name });

        const keyB64 = hash.toString(CryptoJS.enc.Base64); //Convert the key in base 64 to handle easily (url).
        //Encrypt the file with the generated key
        try {
          var crypt = CryptoJS.AES.encrypt(fileJSON, keyB64);
          return [crypt, keyB64];
        } catch (error) {
          alert(error);
        }
      }

      /**
       * Get the uploaded file, encrypt it, save it in the server and generate a share link
       */
      function uploadProcess(e) {
        e.preventDefault()
        const password = document.getElementById("password").value;
        const files = document.getElementById("file").files;

        if (!password) {
          alert("You must choose a password");
          exit(1);
        }

        if (files.length == 0) {
          alert("No file selected");
          exit(1);
        }

        //Read the file in order to convert in a buffer (string)
        const reader = new FileReader();

        //Read data in base 64 format to handle easily
        reader.readAsDataURL(files[0]);

        //When all data are loaded, file is encrypted and share link is created
        reader.addEventListener("load", function () {
          //Encrypt the file with its name
          if (files[0].size > 2097152) {
            alert("File is larger than 2MB!");
            exit(1);
          }

          const crypt = encryptFile(reader.result, password, files[0].name);

          //Create a new POST request to send the encrypted file to the server
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "upload.html");

          //When file is uploaded on the server, create the share link
          xhr.addEventListener(
            "load",
            function () {
              if (
                xhr.readyState == 4 &&
                (xhr.status == 200 || xhr.status == 0)
              ) {
                //Get the file id generated by the server
                const fileID = xhr.responseText;

                //Create the share link with the file id and the key
                var link =
                  window.location.href +
                  "download.html?file=" +
                  fileID +
                  "&id=" +
                  crypt[1];

                //Print the share link
                var message =
                  "Share this link with your friends : <a href=" +
                  link +
                  ">" +
                  link +
                  "</a>";

                //Throw an alert to inform the user
                alert("Upload Successful ! Use the link to share !");
                $("#link").html(message);
              }
            },
            false
          );

          //Create a blob with the encrypted data
          const form = new FormData();
          const blob = new Blob([crypt[0]], { type: "text/xml" });

          //Provide parameter to the POST request : the encrypted file and the captcha validation
          form.append("cryptFile", blob);

          //Send the post request
          xhr.send(form);
        });
      }

      //Initialisation function
      function init() {
        //launch the upload process when upload button is pressed
        $("#form").submit(uploadProcess);
      }

      //Start initialisation process when the user load the page
      $(init);
    </script>
  </body>
</html>
