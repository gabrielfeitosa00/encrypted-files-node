<!--
 * Upload page to send file, encrypt it, save on server and generate download link
 *
 * @author Denis CLAVIER <clavierd at gmail dot com>
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Upload : Share your files, not your secrets</title>
        <!-- Include script SJCL, jquery, recaptcha API and bootstrap -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    </head>
    <body>
        <!-- HTML code to render the upload button and the share link -->
        <div id="main div" class="w3-margin w3-padding-large">
            <h2>Select the file you wanna upload : </h2>

            <!-- Upload button for file -->
            <input class="w3-input" id="file" type="file"  multiple />
     

            <!-- Submit button to start the upload process -->
            <button type="button" class="w3-button w3-teal" id="uploadBtn">Upload</button>
            </br>
            </br>
            <!-- div for the share link -->
            <div id="link"></div>
        </div>
        <!-- JavaScript code to get data, cipher and request the server -->
        <script>
            /**
            * @param string @file
            * The uploaded file (in string format) to encrypt
            * @param string @name
            * The name of the file in order to save it with the file for decryption process
            *
            * @return
            * A string array with 2 elements : the encrypted file and the associated key in base 64
            */
            function encryptFile(file,name)
            {
                //Create a JSON object to bind the file and its name
               
                var fileJSON = JSON.stringify({data: file,name:name});
                console.log(fileJSON)
              
       
                //Genererate a secure random key
                var salt = CryptoJS.lib.WordArray.random(128 / 8); //Get a random salt
                var key= CryptoJS.PBKDF2(name, salt,{keySize:256/32})

               
                var keyB64 = key.toString(CryptoJS.enc.Base64) //Convert the key in base 64 to handle easily (url).
                console.log(`this is the key ${keyB64}`)
                //Encrypt the file with the generated key
                try {
                    var crypt = CryptoJS.AES.encrypt(fileJSON, keyB64);
                    console.log(crypt)
                } catch (error) {
                    alert(error)
                }
                
                return [crypt,keyB64];
            }

            /**
            * Get the uploaded file, encrypt it, save it in the server and generate a share link
            */
            function uploadProcess()
            {
                //Alert thrown if no file has been selected
                if( document.getElementById("file").files.length == 0 ){
                    alert('No file selected');
                    exit(1);
                }


                //If captcha has been checked, the upload process go on
                else
                {
                    //Get the uploaded file
                    var fileInput = document.querySelector('#file');

                    //Read the file in order to convert in a buffer (string)
                    var reader = new FileReader();

                    //Read data in base 64 format to handle easily
                    reader.readAsDataURL(fileInput.files[0]);

                    //When all data are loaded, file is encrypted and share link is created
                    reader.addEventListener('load', function()
                    {
                        //Encrypt the file with its name
                        if(fileInput.files[0].size> 2097152){
                            alert("File is larger than 2MB!")
                            exit(1)
                        }
                       
                        var crypt = encryptFile(reader.result,fileInput.files[0].name);

                        //Create a new POST request to send the encrypted file to the server
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', 'upload.html');

                        //When file is uploaded on the server, create the share link
                        xhr.addEventListener('load', function()
                        {
                            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0))
                            {
                                //Get the file id generated by the server
                                const fileID = xhr.responseText;

                                //Create the share link with the file id and the key
                                var link = window.location.href +'download.html?file=' + fileID + '#' + crypt[1];

                                //Print the share link
                                var message = 'Share this link with your friends : <a href=' + link + '>' + link + '</a>';

                                //Throw an alert to inform the user
                                alert('Upload Successful ! Use the link to share !');
                                $('#link').html(message);
                            }
                        }, false);

                        //Create a blob with the encrypted data
                        var form = new FormData();
                        var blob = new Blob([crypt[0]], { type: "text/xml"});

                        //Provide parameter to the POST request : the encrypted file and the captcha validation
                        form.append('cryptFile', blob);
                      

                        //Send the post request
                        xhr.send(form);
                    });
                }
            }

            //Initialisation function
            function init()
            {
                //launch the upload process when upload button is pressed
                $('#uploadBtn').click(uploadProcess);
            }

            //Start initialisation process when the user load the page
            $(init);

        </script>
    </body>
</html>
