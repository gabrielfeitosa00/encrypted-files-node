<!DOCTYPE html>
<html>
  <head>
    <title>Download : Get your File !</title>

    <!-- Include script SJCL, jquery and bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  </head>

  <body class="bg-light">
    <br/>
    <form id="form" class="w3-margin w3-padding-large">
      <h2 class="text-center">Click on the button below to save the file on your computer !</h2>

      <br/>

      <div class="input-group">
        <input class="w3-input form-control" id="password" type="text" required />
        <div class="input-group-append">
          <button type="submit" class="btn btn-success" id="saveBtn olho">Decrypt file</button> 
        </div>  
      </div>

      <div id="saveLink"></div>
    </form>

    <!-- JavaScript code to get data, cipher and request the server -->
    <script>
      /**
       * @param string @param
       * A parameter name to extract from the page url.
       *
       * @return
       * The value (string) associated to "param" in the page url.
       */
      function getParam(param) {
        var vars = {};
        window.location.href
          .replace(location.hash, "")
          .replace(/[?&]+([^=&]+)=?([^&]*)?/gi, function (m, key, value) {
            vars[key] = value !== undefined ? value : "";
          });

        if (param) {
          return vars[param] ? vars[param] : null;
        }
        return vars;
      }

      /**
       * @param string @file
       * The encrypted file (in string format) to decrypt
       * @param string @keyB64
       * The base 64 of the key to decrypt (had to be the good key to process)
       *
       * @return
       * A string array with 2 elements : the plaintext file (if key is the good one) and the original name of the file
       */
      function decryptFile(file, keyB64) {
        //Convert the key from base 64 to Bits
        try {
          const key = CryptoJS.enc.Base64.parse(keyB64);
          // Decrypt the file with the provided key
          const decrypt = CryptoJS.AES.decrypt(file, keyB64).toString(
            CryptoJS.enc.Utf8
          );

          //Parse the decrypted string to get name and file separately
          const obj = JSON.parse(decrypt);
          return [obj.data, obj.name];
        } catch (error) {
          throw "Seems your file was corrupted :(";
        }
      }

      function Error(msg) {
        return `Error: ${msg}`;
        exit(0);
      }

      /**
       * Get the file and the key from url, decrypt file and generate a link to save the decrypted file
       */
      async function downloadProcess(e) {
        e.preventDefault();
        try {
          const password = document.getElementById("password").value;
          const hash = CryptoJS.SHA256(password).toString(CryptoJS.enc.Base64);
         
          const fileID = getParam("file");

          if (fileID == null) {
            throw Error("File parameter is missing!");
          }

          //Escape and validate the file id parameter in order to prevent attack (code injection, path traversal, remote/local file inclusion)
          const tmpFilepath = fileID.replaceAll("\D+", "");

          //The file id should be an integer, if it is not a number, raise an exception
          const fileRequested = parseInt(tmpFilepath);
          if (isNaN(fileRequested)) {
            throw Error("File parameter is missing or not accepted!");
          }

          const response = await fetch("/" + fileRequested.toString());
          if (response.ok) {
            const data = await response.text();
            const decrypt = decryptFile(data, hash);
            const downloadLink =
              '<a download="' +
              decrypt[1] +
              '" href="' +
              decrypt[0] +
              '"> Save </a>';
            $("#saveLink").append(downloadLink);
          } else {
            const isJson = response.headers
              .get("content-type")
              ?.includes("application/json");
            const data = isJson ? await response.json() : await response.text();

            throw Error(
              data?.message || `Something went wrong: ${response.status}`
            );
          }
        } catch (e) {
          if (typeof e === "string") {
            alert(e);
          }
        }
      }

      function init() {
        // listen to download
        $("#form").submit(downloadProcess);
      }

      $(init);
    </script>
  </body>
</html>
