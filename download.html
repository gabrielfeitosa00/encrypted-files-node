<!DOCTYPE html>
<html>
  <head>
    <title>Download : Get your File !</title>

    <!-- Include script SJCL, jquery and bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  </head>

  <body>
    <form id="form" class="w3-margin w3-padding-large">
      <h2>Click on the button below to save the file on your computer !</h2>

      <input class="w3-input" id="password" type="text" required />
      <button type="submit" class="w3-button w3-teal" id="saveBtn">
        Decrypt file
      </button>
      <div id="saveLink"></div>
    </form>

    <!-- JavaScript code to get data, cipher and request the server -->
    <script>
      /**
       * @param string @param
       * A parameter name to extract from the page url.
       *
       * @return
       * The value (string) associated to "param" in the page url.
       */
      function getParam(param) {
        var vars = {};
        window.location.href
          .replace(location.hash, "")
          .replace(/[?&]+([^=&]+)=?([^&]*)?/gi, function (m, key, value) {
            vars[key] = value !== undefined ? value : "";
          });

        if (param) {
          return vars[param] ? vars[param] : null;
        }
        return vars;
      }

      /**
       * @param string @file
       * The encrypted file (in string format) to decrypt
       * @param string @keyB64
       * The base 64 of the key to decrypt (had to be the good key to process)
       *
       * @return
       * A string array with 2 elements : the plaintext file (if key is the good one) and the original name of the file
       */
      function decryptFile(file, keyB64) {
        //Convert the key from base 64 to Bits
        try {
          const key = CryptoJS.enc.Base64.parse(keyB64);
          // Decrypt the file with the provided key
          const decrypt = CryptoJS.AES.decrypt(file, keyB64).toString(
            CryptoJS.enc.Utf8
          );

          //Parse the decrypted string to get name and file separately
          const obj = JSON.parse(decrypt);
          return [obj.data, obj.name];
        } catch (error) {
          throw "Seems your file was corrupted :(";
        }
      }

      /**
       * Get the file and the key from url, decrypt file and generate a link to save the decrypted file
       */
      async function downloadProcess(e) {
        e.preventDefault();
        try {
          //Get the file id from the url
          const password = document.getElementById("password").value;
          const hash = CryptoJS.SHA256(password).toString(CryptoJS.enc.Base64);
          const hashFromURL = getParam("id");
          const fileID = getParam("file");

          if (!hashFromURL) {
            throw "Error: Missing hash from URL";
            exit(0);
          }
          if (hash !== hashFromURL) {
            throw "Error: Wrong password";
            exit(0);
          }

          //Exception raises if there is no file id in url
          if (fileID == null) {
            throw "Error: File parameter is missing";
            exit(0);
          }

          //Escape and validate the file id parameter in order to prevent attack (code injection, path traversal, remote/local file inclusion)
          var tmpFilepath = fileID.replace("/", "");
          tmpFilepath = tmpFilepath.replace(".", "");

          //The file id should be an integer, if it is not a number, raise an exception
          const fileRequested = parseInt(tmpFilepath);
          if (isNaN(fileRequested)) {
            throw "Error : File parameter is missing or not accepted";
            exit(0);
          }

          const response = await fetch("/" + fileRequested.toString());
          if (response.ok) {
            const data = await response.text();
            const decrypt = decryptFile(data, hash);
            const downloadLink =
              '<a download="' +
              decrypt[1] +
              '" href="' +
              decrypt[0] +
              '"> Save </a>';
            $("#saveLink").append(downloadLink);
          }
        } catch (e) {
          if (typeof e === "string") alert(e);
        }
      }
      function init() {
        // listen to download
        $("#form").submit(downloadProcess);
      }
      $(init);
    </script>
  </body>
</html>
